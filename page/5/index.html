<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="LMna4sDgcxaYDtAGgqEfRDdTI5Qu0bv57Jn-DcpfqoY">














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="go,golang,backend,blog">





  <link rel="alternate" href="/atom.xml" title="hanjm's blog" type="application/atom+xml">






<meta name="description" content="about GO, aboud backend">
<meta property="og:type" content="website">
<meta property="og:title" content="hanjm&#39;s blog">
<meta property="og:url" content="https://imhanjm.com/page/5/index.html">
<meta property="og:site_name" content="hanjm&#39;s blog">
<meta property="og:description" content="about GO, aboud backend">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hanjm&#39;s blog">
<meta name="twitter:description" content="about GO, aboud backend">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- normal -->
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4299650249402142" data-ad-slot="4037719683" data-ad-format="auto" data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>



  <link rel="canonical" href="https://imhanjm.com/page/5/">





  <title>hanjm's blog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-97868201-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">hanjm's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://imhanjm.com/2018/02/17/深入理解NATS & NATS Streaming/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hanjm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hanjm's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/17/深入理解NATS & NATS Streaming/" itemprop="url">深入理解NATS & NATS Streaming (踩坑记)</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-17T00:00:00+08:00">
                2018-02-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/17/深入理解NATS & NATS Streaming/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/17/深入理解NATS & NATS Streaming/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>NATS Server是一个高性能的, cloud native的, 基于发布订阅机制的消息系统, 没有消息持久化功能.<br>NATS Streaming Server是基于NATS Server的, 增加消息持久化功能的消息系统.</p>
<h2 id="NATS-Streaming-持久化特性踩坑记"><a href="#NATS-Streaming-持久化特性踩坑记" class="headerlink" title="NATS Streaming 持久化特性踩坑记"></a>NATS Streaming 持久化特性踩坑记</h2><p>官网的文档并不详细, 很多重要的技术细节没说, 看了官网的文档之后发现用法很简单, 然后直接去写代码, 写publisher代码没什么问题, 写subscriber代码也能正常工作. 但是subscriber一重启, 重启后重启期间publisher发的消息不会继续收到, 说好的持久化呢? 我把官网的文档翻了遍也没找到答案. 最后在项目的readme.md中找到了答案: 要让subscriber重启后能继续收到重启期间发过来的消息且不重复消息, 必须在调用<code>Subscribe(subject string, cb MsgHandler, opts ...SubscriptionOption) (Subscription, error)</code>订阅时设置一样的durableName, 且重启后连接时<code>Connect(stanClusterID, clientID string, options ...Option) (Conn, error)</code>ClusterID、clientID不能变.</p>
<p>要想理解NATS和NATS Streaming的特性, server和client的readme文档都需要仔细阅读, 特别是nats-streaming服务端的readme. 代码也值得阅读研究.</p>
<ul>
<li>gnatsd服务端 <a href="https://github.com/nats-io/gnatsd" target="_blank" rel="noopener">https://github.com/nats-io/gnatsd</a></li>
<li>gnatsd客户端 <a href="https://github.com/nats-io/go-nats" target="_blank" rel="noopener">https://github.com/nats-io/go-nats</a></li>
<li>nats-streaming服务端 <a href="https://github.com/nats-io/nats-streaming-server" target="_blank" rel="noopener">https://github.com/nats-io/nats-streaming-server</a></li>
<li>nats-streaming客户端 <a href="https://github.com/nats-io/go-nats-streaming" target="_blank" rel="noopener">https://github.com/nats-io/go-nats-streaming</a></li>
</ul>
<h2 id="重要特性说明"><a href="#重要特性说明" class="headerlink" title="重要特性说明"></a>重要特性说明</h2><ol>
<li>当subject没有被订阅时, 消息会被直接丢弃, 所以重启订阅者会丢消息, 解决办法: 要么开2个以上客户端实例, 组成队列订阅QueueSubscribe, 要么换NATS Streaming.</li>
<li>clientID和durableName对于NATS Streaming非常重要. 要让subscriber重启后能继续收到重启期间发过来的消息且不重复消息, 必须在调用<code>Subscribe(subject string, cb MsgHandler, opts ...SubscriptionOption) (Subscription, error)</code>订阅时设置一样的durableName, 调用<code>Connect(stanClusterID, clientID string, options ...Option) (Conn, error)</code>连接时ClusterID、clientID不能变. 程序关闭时应该使用Close而不是Unsubscribe, Unsubscribe()会删除在server端删除该持久化订阅.<blockquote>
<p>This client ID links a given connection to its published messages, subscriptions, especially durable subscriptions. Indeed, durable subscriptions are stored as a combination of the client ID and durable name.<br>If an application wishes to resume message consumption from where it previously stopped, it needs to create a durable subscription. It does so by providing a durable name, which is combined with the client ID provided when the client created its connection. The server then maintain the state for this subscription even after the client connection is closed.<br> Note: The starting position given by the client when restarting a durable subscription is ignored.<br> When the application wants to stop receiving messages on a durable subscription, it should close - but <em>not unsubscribe</em>- this subscription. If a given client library does not have the option to close a subscription, the application should close the connection instead.<br> When the application wants to delete the subscription, it must unsubscribe it. Once unsubscribed, the state is removed and it is then possible to re-use the durable name, but it will be considered a brand new durable subscription, with the start position being the one given by the client when creating the durable subscription.</p>
</blockquote>
</li>
</ol>
<h4 id><a href="#" class="headerlink" title></a><a href="https://github.com/nats-io/nats-streaming-server#queue-group" target="_blank" rel="noopener"></a></h4><ol start="3">
<li><p>NATS连接时可以设置客户端的名字, 这样在monitor界面中的/connz就能方便地看到各个客户端的统计数据.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// Options that can be passed to Connect.   // Name is an Option to set the client name. func Name(name string) Option &#123;</span><br><span class="line">   return func(o *Options) error &#123;</span><br><span class="line">      o.Name = name</span><br><span class="line">      return nil</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type ConnInfo struct &#123;</span><br><span class="line">	Cid            uint64    `json:&quot;cid&quot;`</span><br><span class="line">	IP             string    `json:&quot;ip&quot;`</span><br><span class="line">	Port           int       `json:&quot;port&quot;`</span><br><span class="line">	Start          time.Time `json:&quot;start&quot;`</span><br><span class="line">	LastActivity   time.Time `json:&quot;last_activity&quot;`</span><br><span class="line">	Uptime         string    `json:&quot;uptime&quot;`</span><br><span class="line">	Idle           string    `json:&quot;idle&quot;`</span><br><span class="line">	Pending        int       `json:&quot;pending_bytes&quot;`</span><br><span class="line">	InMsgs         int64     `json:&quot;in_msgs&quot;`</span><br><span class="line">	OutMsgs        int64     `json:&quot;out_msgs&quot;`</span><br><span class="line">	InBytes        int64     `json:&quot;in_bytes&quot;`</span><br><span class="line">	OutBytes       int64     `json:&quot;out_bytes&quot;`</span><br><span class="line">	NumSubs        uint32    `json:&quot;subscriptions&quot;`</span><br><span class="line">	Name           string    `json:&quot;name,omitempty&quot;`</span><br><span class="line">	Lang           string    `json:&quot;lang,omitempty&quot;`</span><br><span class="line">	Version        string    `json:&quot;version,omitempty&quot;`</span><br><span class="line">	TLSVersion     string    `json:&quot;tls_version,omitempty&quot;`</span><br><span class="line">	TLSCipher      string    `json:&quot;tls_cipher_suite,omitempty&quot;`</span><br><span class="line">	AuthorizedUser string    `json:&quot;authorized_user,omitempty&quot;`</span><br><span class="line">	Subs           []string  `json:&quot;subscriptions_list,omitempty&quot;`</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用.来分隔subject的级别. NATS允许subject包含斜杠/符号, 但NATS Streaming不允许, 因为NATS Streaming持久化时会使用subject名字来作为文件夹名, </p>
<ul>
<li>NATS的subject可以为任意不为空的字符串, 具体的subject不能包含通配符’*’和’&gt;’.</li>
<li>NATS Streaming的subject不能为空, 首尾不能为点’.’, 不能包含两个连续的点’.’, 由于暂时不支持通配符订阅功能, 所以不能包含’*’和’&gt;’.</li>
</ul>
</li>
<li>NATS Streaming Server实际上是内嵌了一个NATS Server, 自己作为NATS的客户端. NATS Streaming的客户端实际上没有和NATS Streaming Server直接连接, 而是连接内嵌的NATS Server, NATS Streaming Server通过订阅客户端的心跳来知道NATS Streaming客户端连接有没有断开. 所以它强烈建议客户端退出程序时主动Close.</li>
<li>NATS可以热重新加载配置, 发送SIGHUP信号或<code>gnatsd -sl reload</code>即可.</li>
<li>开发环境可以加<code>-V</code>参数了解NATS, 生产环境就没必要了, 否则会把发过来的消息全打在日志里.</li>
<li>你甚至可以用NATS的client包publish消息到NATS Streaming, NATS的client可以subscribe, 但NATS Streaming的client无法subscribe, 因为内部的subject变了. 最好不用混用, 容易出问题.</li>
<li><p>NATS Streaming客户端连接时提供的ClusterID和服务端启动配置的ClusterID不一致时会报, 有人表示费解吐槽过, <a href="https://github.com/nats-io/nats-streaming-server/issues/309" target="_blank" rel="noopener">https://github.com/nats-io/nats-streaming-server/issues/309</a>, 但官方解释说没有问题, Timeout也说的通.</p>
<blockquote>
<p>If you provide a cluster ID not used by any of the servers in the network, no server will respond to the client, hence the timeout error message from the client library. If anything, this is an error message that needs to be updated in the client libraries, not in the server.</p>
</blockquote>
</li>
<li><p>ChanSubscribe方式的客户端优雅关闭, 等待消息处理完成.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">   &quot;fmt&quot;</span><br><span class="line"> &quot;os&quot; &quot;syscall&quot; &quot;os/signal&quot; &quot;github.com/nats-io/go-nats&quot; &quot;sync&quot; )</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">   n, err := nats.Connect(&quot;nats://127.0.0.1:7222&quot;,</span><br><span class="line">  nats.Name(&quot;test_client&quot;),</span><br><span class="line">  nats.UserInfo(&quot;&quot;, &quot;&quot;))</span><br><span class="line">   if err != nil &#123;</span><br><span class="line">      panic(err)</span><br><span class="line">   &#125;</span><br><span class="line">   subject := &quot;test&quot;</span><br><span class="line">  msgCh := make(chan *nats.Msg, nats.DefaultMaxChanLen)</span><br><span class="line">   _, err = n.ChanSubscribe(subject, msgCh)</span><br><span class="line">   if err != nil &#123;</span><br><span class="line">      panic(err)</span><br><span class="line">   &#125;</span><br><span class="line">   wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">   for i := 0; i &lt; 2; i++ &#123;</span><br><span class="line">      wg.Add(1)</span><br><span class="line">      go func() &#123;</span><br><span class="line">         defer wg.Done()</span><br><span class="line">         // msg handler</span><br><span class="line">  for msg := range msgCh &#123;</span><br><span class="line">            fmt.Printf(&quot;%s\n&quot;, msg.Data)</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;()</span><br><span class="line">   &#125;</span><br><span class="line">   quit := make(chan os.Signal)</span><br><span class="line">   signal.Notify(quit, syscall.SIGQUIT,</span><br><span class="line">  syscall.SIGTERM,</span><br><span class="line">  syscall.SIGINT,</span><br><span class="line">  syscall.SIGUSR1,</span><br><span class="line">  syscall.SIGUSR2)</span><br><span class="line">   select &#123;</span><br><span class="line">   case &lt;-quit:</span><br><span class="line">      defer wg.Wait()</span><br><span class="line">      // close msgCh and wait process ok</span><br><span class="line">      close(msgCh)</span><br><span class="line">      n.Flush()</span><br><span class="line">      n.Close()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="NATS代码中的技巧"><a href="#NATS代码中的技巧" class="headerlink" title="NATS代码中的技巧"></a>NATS代码中的技巧</h2><ol>
<li><p>很有用的Go风格的可选参数设计模式, 很多地方见过.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// Option is a function on the options for a connection. </span><br><span class="line">type Option func(*Options) error</span><br><span class="line"></span><br><span class="line">// Options can be used to create a customized connection. </span><br><span class="line">type Options struct &#123; </span><br><span class="line">  Url string   </span><br><span class="line"> ... </span><br><span class="line">  User string</span><br><span class="line">  Password string</span><br><span class="line">&#125;</span><br><span class="line">var DefaultOptions = Options&#123;</span><br><span class="line">   AllowReconnect:   true,</span><br><span class="line">  MaxReconnect:     DefaultMaxReconnect,</span><br><span class="line">  ReconnectWait:    DefaultReconnectWait,</span><br><span class="line">  Timeout:          DefaultTimeout,</span><br><span class="line">  PingInterval:     DefaultPingInterval,</span><br><span class="line">  MaxPingsOut:      DefaultMaxPingOut,</span><br><span class="line">  SubChanLen:       DefaultMaxChanLen,</span><br><span class="line">  ReconnectBufSize: DefaultReconnectBufSize,</span><br><span class="line">  Dialer: &amp;net.Dialer&#123;</span><br><span class="line">      Timeout: DefaultTimeout,</span><br><span class="line">  &#125;, &#125;</span><br><span class="line"></span><br><span class="line">// Connect will attempt to connect to the NATS system. </span><br><span class="line">// The url can contain username/password semantics. e.g. nats://derek:pass@localhost:4222 </span><br><span class="line">// Comma separated arrays are also supported, e.g. urlA, urlB. </span><br><span class="line">// Options start with the defaults but can be overridden. </span><br><span class="line">func Connect(url string, options ...Option) (*Conn, error) &#123;</span><br><span class="line">   opts := DefaultOptions</span><br><span class="line">   opts.Servers = processUrlString(url)</span><br><span class="line">   for _, opt := range options &#123;</span><br><span class="line">      if err := opt(&amp;opts); err != nil &#123;</span><br><span class="line">         return nil, err</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   return opts.Connect()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Options that can be passed to Connect.   // Name is an Option to set the client name. func Name(name string) Option &#123;</span><br><span class="line">   return func(o *Options) error &#123;</span><br><span class="line">      o.Name = name</span><br><span class="line">      return nil</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用ringBuffer限制消息数量</p>
<blockquote>
<pre><code>You can view a message log as a ring buffer. Messages are appended to the end of the log. If a limit is set globally for all channels, or specifically for this channel, when the limit is reached, older messages are removed to make room for the new ones.
</code></pre></blockquote>
</li>
<li><p>用reflect来绑定任意类型的chan</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chVal := reflect.ValueOf(channel)</span><br><span class="line">if chVal.Kind() != reflect.Chan &#123;</span><br><span class="line">   return ErrChanArg</span><br><span class="line">&#125;</span><br><span class="line">val, ok := chVal.Recv()</span><br><span class="line">if !ok &#123;</span><br><span class="line">   // Channel has most likely been closed.</span><br><span class="line">  return </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://imhanjm.com/2017/10/29/深入理解golang时间处理(time.Time)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hanjm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hanjm's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/29/深入理解golang时间处理(time.Time)/" itemprop="url">深入理解GO时间处理(time.Time)</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-29T00:00:00+08:00">
                2017-10-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/29/深入理解golang时间处理(time.Time)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/29/深入理解golang时间处理(time.Time)/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>时间包括时间值和时区, 没有包含时区信息的时间是不完整的、有歧义的. 和外界传递或解析时间数据时, 应当像HTTP协议或unix-timestamp那样, 使用没有时区歧义的格式, 如果使用某些没有包含时区的非标准的时间表示格式(如yyyy-mm-dd HH:MM:SS), 是有隐患的, 因为解析时会使用场景的默认设置, 如系统时区, 数据库默认时区可能引发事故. 确保服务器系统、数据库、应用程序使用统一的时区, 如果因为一些历史原因, 应用程序各自保持着不同时区, 那么编程时要小心检查代码, 知道时间数据在使用不同时区的程序之间交换时的行为. 第三节会详细解释go程序在不同场景下time.Time的行为.</p>
<h2 id="2-Time的数据结构"><a href="#2-Time的数据结构" class="headerlink" title="2. Time的数据结构"></a>2. Time的数据结构</h2><p>go1.9之前, time.Time的定义为</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Time <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// sec gives the number of seconds elapsed since</span></span><br><span class="line">	<span class="comment">// January 1, year 1 00:00:00 UTC.</span></span><br><span class="line">	sec <span class="keyword">int64</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// nsec specifies a non-negative nanosecond</span></span><br><span class="line">	<span class="comment">// offset within the second named by Seconds.</span></span><br><span class="line">	<span class="comment">// It must be in the range [0, 999999999].</span></span><br><span class="line">	nsec <span class="keyword">int32</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// loc specifies the Location that should be used to</span></span><br><span class="line">	<span class="comment">// determine the minute, hour, month, day, and year</span></span><br><span class="line">	<span class="comment">// that correspond to this Time.</span></span><br><span class="line">	<span class="comment">// The nil location means UTC.</span></span><br><span class="line">	<span class="comment">// All UTC times are represented with loc==nil, never loc==&amp;utcLoc.</span></span><br><span class="line">	loc *Location</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sec表示从公元1年1月1日00:00:00UTC到要表示的整数秒数, nsec表示余下的纳秒数, loc表示时区. sec和nsec处理没有歧义的时间值, loc处理偏移量.</p>
<p>因为2017年闰一秒, 国际时钟调整, Go程序两次取time.Now()相减的时间差得到了意料之外的负数, 导致cloudFlare的CDN服务中断, 详见<a href="https://blog.cloudflare.com/how-and-why-the-leap-second-affected-cloudflare-dns/" target="_blank" rel="noopener">https://blog.cloudflare.com/how-and-why-the-leap-second-affected-cloudflare-dns/</a>, go1.9在不影响已有应用代码的情况下修改了time.Time的实现. go1.9的time.Time定义为</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// A Time represents an instant in time with nanosecond precision.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Programs using times should typically store and pass them as values,</span></span><br><span class="line"><span class="comment">// not pointers. That is, time variables and struct fields should be of</span></span><br><span class="line"><span class="comment">// type time.Time, not *time.Time.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// A Time value can be used by multiple goroutines simultaneously except</span></span><br><span class="line"><span class="comment">// that the methods GobDecode, UnmarshalBinary, UnmarshalJSON and</span></span><br><span class="line"><span class="comment">// UnmarshalText are not concurrency-safe.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Time instants can be compared using the Before, After, and Equal methods.</span></span><br><span class="line"><span class="comment">// The Sub method subtracts two instants, producing a Duration.</span></span><br><span class="line"><span class="comment">// The Add method adds a Time and a Duration, producing a Time.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The zero value of type Time is January 1, year 1, 00:00:00.000000000 UTC.</span></span><br><span class="line"><span class="comment">// As this time is unlikely to come up in practice, the IsZero method gives</span></span><br><span class="line"><span class="comment">// a simple way of detecting a time that has not been initialized explicitly.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Each Time has associated with it a Location, consulted when computing the</span></span><br><span class="line"><span class="comment">// presentation form of the time, such as in the Format, Hour, and Year methods.</span></span><br><span class="line"><span class="comment">// The methods Local, UTC, and In return a Time with a specific location.</span></span><br><span class="line"><span class="comment">// Changing the location in this way changes only the presentation; it does not</span></span><br><span class="line"><span class="comment">// change the instant in time being denoted and therefore does not affect the</span></span><br><span class="line"><span class="comment">// computations described in earlier paragraphs.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Note that the Go == operator compares not just the time instant but also the</span></span><br><span class="line"><span class="comment">// Location and the monotonic clock reading. Therefore, Time values should not</span></span><br><span class="line"><span class="comment">// be used as map or database keys without first guaranteeing that the</span></span><br><span class="line"><span class="comment">// identical Location has been set for all values, which can be achieved</span></span><br><span class="line"><span class="comment">// through use of the UTC or Local method, and that the monotonic clock reading</span></span><br><span class="line"><span class="comment">// has been stripped by setting t = t.Round(0). In general, prefer t.Equal(u)</span></span><br><span class="line"><span class="comment">// to t == u, since t.Equal uses the most accurate comparison available and</span></span><br><span class="line"><span class="comment">// correctly handles the case when only one of its arguments has a monotonic</span></span><br><span class="line"><span class="comment">// clock reading.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In addition to the required “wall clock” reading, a Time may contain an optional</span></span><br><span class="line"><span class="comment">// reading of the current process's monotonic clock, to provide additional precision</span></span><br><span class="line"><span class="comment">// for comparison or subtraction.</span></span><br><span class="line"><span class="comment">// See the “Monotonic Clocks” section in the package documentation for details.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">type</span> Time <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// wall and ext encode the wall time seconds, wall time nanoseconds,</span></span><br><span class="line">	<span class="comment">// and optional monotonic clock reading in nanoseconds.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// From high to low bit position, wall encodes a 1-bit flag (hasMonotonic),</span></span><br><span class="line">	<span class="comment">// a 33-bit seconds field, and a 30-bit wall time nanoseconds field.</span></span><br><span class="line">	<span class="comment">// The nanoseconds field is in the range [0, 999999999].</span></span><br><span class="line">	<span class="comment">// If the hasMonotonic bit is 0, then the 33-bit field must be zero</span></span><br><span class="line">	<span class="comment">// and the full signed 64-bit wall seconds since Jan 1 year 1 is stored in ext.</span></span><br><span class="line">	<span class="comment">// If the hasMonotonic bit is 1, then the 33-bit field holds a 33-bit</span></span><br><span class="line">	<span class="comment">// unsigned wall seconds since Jan 1 year 1885, and ext holds a</span></span><br><span class="line">	<span class="comment">// signed 64-bit monotonic clock reading, nanoseconds since process start.</span></span><br><span class="line">	wall <span class="keyword">uint64</span></span><br><span class="line">	ext  <span class="keyword">int64</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// loc specifies the Location that should be used to</span></span><br><span class="line">	<span class="comment">// determine the minute, hour, month, day, and year</span></span><br><span class="line">	<span class="comment">// that correspond to this Time.</span></span><br><span class="line">	<span class="comment">// The nil location means UTC.</span></span><br><span class="line">	<span class="comment">// All UTC times are represented with loc==nil, never loc==&amp;utcLoc.</span></span><br><span class="line">	loc *Location</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-time的行为"><a href="#3-time的行为" class="headerlink" title="3. time的行为"></a>3. time的行为</h2><ol>
<li><p>构造时间-获取现在时间-time.Now(), time.Now()使用本地时间, time.Local即本地时区, 取决于运行的系统环境设置, 优先取”TZ”这个环境变量, 然后取/etc/localtime, 都取不到就用UTC兜底.</p>
 <figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Now</span><span class="params">()</span> <span class="title">Time</span></span> &#123;</span><br><span class="line">	sec, nsec := now()</span><br><span class="line">	<span class="keyword">return</span> Time&#123;sec + unixToInternal, nsec, Local&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>构造时间-获取某一时区的现在时间-time.Now().In(), Time结构体的<code>In()</code>方法仅设置loc, 不会改变时间值. 特别地, 如果是获取现在的UTC时间, 可以使用Time.Now().UTC().<br>时区不能为nil. time包中只有两个时区变量time.Local和time.UTC. 其他时区变量有两种方法取得, 一个是通过time.LoadLocation函数根据时区名字加载, 时区名字见<a href="https://www.iana.org/time-zones" target="_blank" rel="noopener">IANA Time Zone database</a>, LoadLocation首先查找系统zoneinfo, 然后查找<code>$GOROOT/lib/time/zoneinfo.zip</code>.另一个是在知道时区名字和偏移量的情况下直接调用<code>time.FixedZone(&quot;$zonename&quot;, $offsetSecond)</code>构造一个Location对象.</p>
 <figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// In returns t with the location information set to loc.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In panics if loc is nil.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t Time)</span> <span class="title">In</span><span class="params">(loc *Location)</span> <span class="title">Time</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> loc == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"time: missing Location in call to Time.In"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	t.setLoc(loc)</span><br><span class="line">	<span class="keyword">return</span> t</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LoadLocation returns the Location with the given name.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If the name is "" or "UTC", LoadLocation returns UTC.</span></span><br><span class="line"><span class="comment">// If the name is "Local", LoadLocation returns Local.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Otherwise, the name is taken to be a location name corresponding to a file</span></span><br><span class="line"><span class="comment">// in the IANA Time Zone database, such as "America/New_York".</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The time zone database needed by LoadLocation may not be</span></span><br><span class="line"><span class="comment">// present on all systems, especially non-Unix systems.</span></span><br><span class="line"><span class="comment">// LoadLocation looks in the directory or uncompressed zip file</span></span><br><span class="line"><span class="comment">// named by the ZONEINFO environment variable, if any, then looks in</span></span><br><span class="line"><span class="comment">// known installation locations on Unix systems,</span></span><br><span class="line"><span class="comment">// and finally looks in $GOROOT/lib/time/zoneinfo.zip.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoadLocation</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(*Location, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> name == <span class="string">""</span> || name == <span class="string">"UTC"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> UTC, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> name == <span class="string">"Local"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Local, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> zoneinfo != <span class="string">""</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> z, err := loadZoneFile(zoneinfo, name); err == <span class="literal">nil</span> &#123;</span><br><span class="line">			z.name = name</span><br><span class="line">			<span class="keyword">return</span> z, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> loadLocation(name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>构造时间-手动构造时间-time.Date(), 传入年元日时分秒纳秒和时区变量Location构造一个时间. 得到的是指定location的时间.</p>
 <figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Date</span><span class="params">(year <span class="keyword">int</span>, month Month, day, hour, min, sec, nsec <span class="keyword">int</span>, loc *Location)</span> <span class="title">Time</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> loc == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"time: missing Location in call to Date"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">.....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li>构造时间-从unix时间戳中构造时间, time.Unix(), 传入秒和纳秒构造.</li>
<li><p>序列化反序列化时间-文本和JSON, fmt.Sprintf,fmt.SScanf, json.Marshal, json.Unmarshal时的, 使用的时间格式均包含时区信息, 序列化使用RFC3339Nano()”2006-01-02T15:04:05.999999999Z07:00”, 反序列化使用RFC3339()”2006-01-02T15:04:05Z07:00”, 反序列化没有纳秒值也可以正常序列化成功.</p>
 <figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// String returns the time formatted using the format string</span></span><br><span class="line"><span class="comment">//	"2006-01-02 15:04:05.999999999 -0700 MST"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t Time)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> t.Format(<span class="string">"2006-01-02 15:04:05.999999999 -0700 MST"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// MarshalJSON implements the json.Marshaler interface.</span></span><br><span class="line"><span class="comment">// The time is a quoted string in RFC 3339 format, with sub-second precision added if present.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t Time)</span> <span class="title">MarshalJSON</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> y := t.Year(); y &lt; <span class="number">0</span> || y &gt;= <span class="number">10000</span> &#123;</span><br><span class="line">		<span class="comment">// RFC 3339 is clear that years are 4 digits exactly.</span></span><br><span class="line">		<span class="comment">// See golang.org/issue/4556#c15 for more discussion.</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"Time.MarshalJSON: year outside of range [0,9999]"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">0</span>, <span class="built_in">len</span>(RFC3339Nano)+<span class="number">2</span>)</span><br><span class="line">	b = <span class="built_in">append</span>(b, <span class="string">'"'</span>)</span><br><span class="line">	b = t.AppendFormat(b, RFC3339Nano)</span><br><span class="line">	b = <span class="built_in">append</span>(b, <span class="string">'"'</span>)</span><br><span class="line">	<span class="keyword">return</span> b, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnmarshalJSON implements the json.Unmarshaler interface.</span></span><br><span class="line"><span class="comment">// The time is expected to be a quoted string in RFC 3339 format.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Time)</span> <span class="title">UnmarshalJSON</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// Ignore null, like in the main JSON package.</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">string</span>(data) == <span class="string">"null"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Fractional seconds are handled implicitly by Parse.</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	*t, err = Parse(<span class="string">`"`</span>+RFC3339+<span class="string">`"`</span>, <span class="keyword">string</span>(data))</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>序列化反序列化时间-HTTP协议中的date, 统一GMT, 代码位于net/http/server.go:878</p>
 <figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TimeFormat is the time format to use when generating times in HTTP</span></span><br><span class="line"><span class="comment">// headers. It is like time.RFC1123 but hard-codes GMT as the time</span></span><br><span class="line"><span class="comment">// zone. The time being formatted must be in UTC for Format to</span></span><br><span class="line"><span class="comment">// generate the correct format.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// For parsing this time format, see ParseTime.</span></span><br><span class="line"><span class="keyword">const</span> TimeFormat = <span class="string">"Mon, 02 Jan 2006 15:04:05 GMT"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>序列化反序列化时间-<code>time.Format(&quot;$layout&quot;)</code>, <code>time.Parse(&quot;$layout&quot;,&quot;$value&quot;)</code>, <code>time.ParseInLocation(&quot;$layout&quot;,&quot;$value&quot;,&quot;$Location&quot;)</code></p>
<ul>
<li><code>time.Format(&quot;$layout&quot;)</code>格式化时间时, 时区会参与计算. 调time.Time的Year()Month()Day()等获取年月日等时时区会参与计算, 得到一个使用偏移量修正过的正确的时间字符串, 若<code>$layout</code>有指定显示时区, 那么时区信息会体现在格式化后的时间字符串中. 如果<code>$layout</code>没有指定显示时区, 那么字符串只有时间没有时区, 时区是隐含的, time.Time对象中的时区.</li>
<li><code>time.Parse(&quot;$layout&quot;,&quot;$value&quot;)</code>, 若<code>$layout</code>有指定显示时区, 那么时区信息会体现在格式化后的time.Time对象. <strong>如果<code>$layout</code>没有指定显示时区, 那么使用会认为这是一个UTC时间, 时区是UTC.</strong></li>
<li><p><code>time.ParseInLocation(&quot;$layout&quot;,&quot;$value&quot;,&quot;$Location&quot;)</code> 使用传参的时区解析时间, 建议用这个, 没有歧义.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Parse parses a formatted string and returns the time value it represents.</span></span><br><span class="line"><span class="comment">// The layout  defines the format by showing how the reference time,</span></span><br><span class="line"><span class="comment">// defined to be</span></span><br><span class="line"><span class="comment">//	Mon Jan 2 15:04:05 -0700 MST 2006</span></span><br><span class="line"><span class="comment">// would be interpreted if it were the value; it serves as an example of</span></span><br><span class="line"><span class="comment">// the input format. The same interpretation will then be made to the</span></span><br><span class="line"><span class="comment">// input string.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Predefined layouts ANSIC, UnixDate, RFC3339 and others describe standard</span></span><br><span class="line"><span class="comment">// and convenient representations of the reference time. For more information</span></span><br><span class="line"><span class="comment">// about the formats and the definition of the reference time, see the</span></span><br><span class="line"><span class="comment">// documentation for ANSIC and the other constants defined by this package.</span></span><br><span class="line"><span class="comment">// Also, the executable example for time.Format demonstrates the working</span></span><br><span class="line"><span class="comment">// of the layout string in detail and is a good reference.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Elements omitted from the value are assumed to be zero or, when</span></span><br><span class="line"><span class="comment">// zero is impossible, one, so parsing "3:04pm" returns the time</span></span><br><span class="line"><span class="comment">// corresponding to Jan 1, year 0, 15:04:00 UTC (note that because the year is</span></span><br><span class="line"><span class="comment">// 0, this time is before the zero Time).</span></span><br><span class="line"><span class="comment">// Years must be in the range 0000..9999. The day of the week is checked</span></span><br><span class="line"><span class="comment">// for syntax but it is otherwise ignored.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In the absence of a time zone indicator, Parse returns a time in UTC.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// When parsing a time with a zone offset like -0700, if the offset corresponds</span></span><br><span class="line"><span class="comment">// to a time zone used by the current location (Local), then Parse uses that</span></span><br><span class="line"><span class="comment">// location and zone in the returned time. Otherwise it records the time as</span></span><br><span class="line"><span class="comment">// being in a fabricated location with time fixed at the given zone offset.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// No checking is done that the day of the month is within the month's</span></span><br><span class="line"><span class="comment">// valid dates; any one- or two-digit value is accepted. For example</span></span><br><span class="line"><span class="comment">// February 31 and even February 99 are valid dates, specifying dates</span></span><br><span class="line"><span class="comment">// in March and May. This behavior is consistent with time.Date.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// When parsing a time with a zone abbreviation like MST, if the zone abbreviation</span></span><br><span class="line"><span class="comment">// has a defined offset in the current location, then that offset is used.</span></span><br><span class="line"><span class="comment">// The zone abbreviation "UTC" is recognized as UTC regardless of location.</span></span><br><span class="line"><span class="comment">// If the zone abbreviation is unknown, Parse records the time as being</span></span><br><span class="line"><span class="comment">// in a fabricated location with the given zone abbreviation and a zero offset.</span></span><br><span class="line"><span class="comment">// This choice means that such a time can be parsed and reformatted with the</span></span><br><span class="line"><span class="comment">// same layout losslessly, but the exact instant used in the representation will</span></span><br><span class="line"><span class="comment">// differ by the actual zone offset. To avoid such problems, prefer time layouts</span></span><br><span class="line"><span class="comment">// that use a numeric zone offset, or use ParseInLocation.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Parse</span><span class="params">(layout, value <span class="keyword">string</span>)</span> <span class="params">(Time, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> parse(layout, value, UTC, Local)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ParseInLocation is like Parse but differs in two important ways.</span></span><br><span class="line"><span class="comment">// First, in the absence of time zone information, Parse interprets a time as UTC;</span></span><br><span class="line"><span class="comment">// ParseInLocation interprets the time as in the given location.</span></span><br><span class="line"><span class="comment">// Second, when given a zone offset or abbreviation, Parse tries to match it</span></span><br><span class="line"><span class="comment">// against the Local location; ParseInLocation uses the given location.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ParseInLocation</span><span class="params">(layout, value <span class="keyword">string</span>, loc *Location)</span> <span class="params">(Time, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> parse(layout, value, loc, loc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parse</span><span class="params">(layout, value <span class="keyword">string</span>, defaultLocation, local *Location)</span> <span class="params">(Time, error)</span></span> &#123;</span><br><span class="line">.....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>序列化反序列化时间-go-sql-driver/mysql中的时间处理.<br>MySQL驱动解析时间的前提是连接字符串加了parseTime和loc, 如果parseTime为false, 会把mysql的date类型变成[]byte/string自行处理, parseTime为true才处理时间, loc指定MySQL中存储时间数据的时区, 如果没有指定loc, 用UTC. 序列化和反序列化均使用连接字符串中的设定的loc, SQL语句中的time.Time类型的参数的时区信息如果和loc不同, 则会调用<code>t.In(loc)</code>方法转时区.</p>
<ul>
<li><p>解析连接字符串的代码位于parseDSNParams函数<a href="https://github.com/go-sql-driver/mysql/blob/master/dsn.go#L467-L490" target="_blank" rel="noopener">https://github.com/go-sql-driver/mysql/blob/master/dsn.go#L467-L490</a></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">	<span class="comment">// Time Location</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"loc"</span>:</span><br><span class="line">	<span class="keyword">if</span> value, err = url.QueryUnescape(value); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	cfg.Loc, err = time.LoadLocation(value)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">// time.Time parsing</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"parseTime"</span>:</span><br><span class="line">	<span class="keyword">var</span> isBool <span class="keyword">bool</span></span><br><span class="line">	cfg.ParseTime, isBool = readBool(value)</span><br><span class="line">	<span class="keyword">if</span> !isBool &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">"invalid bool value: "</span> + value)</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>解析SQL语句中time.Time类型的参数的代码位于mysqlConn.interpolateParams方法<a href="https://github.com/go-sql-driver/mysql/blob/master/connection.go#L230-L273" target="_blank" rel="noopener">https://github.com/go-sql-driver/mysql/blob/master/connection.go#L230-L273</a></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> time.Time:</span><br><span class="line">	<span class="keyword">if</span> v.IsZero() &#123;</span><br><span class="line">		buf = <span class="built_in">append</span>(buf, <span class="string">"'0000-00-00'"</span>...)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		v := v.In(mc.cfg.Loc)</span><br><span class="line">		v = v.Add(time.Nanosecond * <span class="number">500</span>) <span class="comment">// To round under microsecond</span></span><br><span class="line">		year := v.Year()</span><br><span class="line">		year100 := year / <span class="number">100</span></span><br><span class="line">		year1 := year % <span class="number">100</span></span><br><span class="line">		month := v.Month()</span><br><span class="line">		day := v.Day()</span><br><span class="line">		hour := v.Hour()</span><br><span class="line">		minute := v.Minute()</span><br><span class="line">		second := v.Second()</span><br><span class="line">		micro := v.Nanosecond() / <span class="number">1000</span></span><br><span class="line">	</span><br><span class="line">		buf = <span class="built_in">append</span>(buf, []<span class="keyword">byte</span>&#123;</span><br><span class="line">			<span class="string">'\''</span>,</span><br><span class="line">			digits10[year100], digits01[year100],</span><br><span class="line">			digits10[year1], digits01[year1],</span><br><span class="line">			<span class="string">'-'</span>,</span><br><span class="line">			digits10[month], digits01[month],</span><br><span class="line">			<span class="string">'-'</span>,</span><br><span class="line">			digits10[day], digits01[day],</span><br><span class="line">			<span class="string">' '</span>,</span><br><span class="line">			digits10[hour], digits01[hour],</span><br><span class="line">			<span class="string">':'</span>,</span><br><span class="line">			digits10[minute], digits01[minute],</span><br><span class="line">			<span class="string">':'</span>,</span><br><span class="line">			digits10[second], digits01[second],</span><br><span class="line">		&#125;...)</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">if</span> micro != <span class="number">0</span> &#123;</span><br><span class="line">			micro10000 := micro / <span class="number">10000</span></span><br><span class="line">			micro100 := micro / <span class="number">100</span> % <span class="number">100</span></span><br><span class="line">			micro1 := micro % <span class="number">100</span></span><br><span class="line">			buf = <span class="built_in">append</span>(buf, []<span class="keyword">byte</span>&#123;</span><br><span class="line">				<span class="string">'.'</span>,</span><br><span class="line">				digits10[micro10000], digits01[micro10000],</span><br><span class="line">				digits10[micro100], digits01[micro100],</span><br><span class="line">				digits10[micro1], digits01[micro1],</span><br><span class="line">			&#125;...)</span><br><span class="line">		&#125;</span><br><span class="line">		buf = <span class="built_in">append</span>(buf, <span class="string">'\''</span>)</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>从MySQL数据流中解析时间的代码位于textRows.readRow方法<a href="https://github.com/go-sql-driver/mysql/blob/master/packets.go#L772-L777" target="_blank" rel="noopener">https://github.com/go-sql-driver/mysql/blob/master/packets.go#L772-L777</a>, <strong>注意只要MySQL连接字符串设置了parseTime=true, 就会解析时间, 不管你是用string还是time.Time接收的.</strong></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> !isNull &#123;</span><br><span class="line">				<span class="keyword">if</span> !mc.parseTime &#123;</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">switch</span> rows.rs.columns[i].fieldType &#123;</span><br><span class="line">					<span class="keyword">case</span> fieldTypeTimestamp, fieldTypeDateTime,</span><br><span class="line">						fieldTypeDate, fieldTypeNewDate:</span><br><span class="line">						dest[i], err = parseDateTime(</span><br><span class="line">							<span class="keyword">string</span>(dest[i].([]<span class="keyword">byte</span>)),</span><br><span class="line">							mc.cfg.Loc,</span><br><span class="line">						)</span><br><span class="line">						<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">							<span class="keyword">continue</span></span><br><span class="line">						&#125;</span><br><span class="line">					<span class="keyword">default</span>:</span><br><span class="line">						<span class="keyword">continue</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h2 id="4-time时区处理不当案例"><a href="#4-time时区处理不当案例" class="headerlink" title="4. time时区处理不当案例"></a>4. time时区处理不当案例</h2><ol>
<li><p>有个服务频繁使用最新汇率, 所以缓存了最新汇率对象, 汇率对象的过期时间设为第二天北京时间零点, 汇率过期则从数据库中去最新汇率, 设置过期时间的代码如下:</p>
 <figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> startTime <span class="keyword">string</span> = time.Now().UTC().Add(<span class="number">8</span> * 	time.Hour).Format(<span class="string">"2006-01-02"</span>)</span><br><span class="line">tm2, _ := time.Parse(<span class="string">"2006-01-02"</span>, startTime)</span><br><span class="line">lastTime = tm2.Unix() + <span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span></span><br></pre></td></tr></table></figure>
<p> 这段代码使用了time.Parse, 如果时间格式中没有指定时区, 那么会得到使用本地时区下的第二天零点, 服务器时区设置为UTC0, 于是汇率缓存在UTC零点即北京时间八点才更新.</p>
</li>
<li><p>公共库中有一个GetBjTime()方法, 注释写着将服务器UTC转成北京时间, 代码如下</p>
 <figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 原版</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetBjTime</span><span class="params">()</span> <span class="title">time</span>.<span class="title">Time</span></span> &#123;</span><br><span class="line"><span class="comment">// 将服务器UTC转成北京时间</span></span><br><span class="line">uTime := time.Now().UTC()</span><br><span class="line">dur, _ := time.ParseDuration(<span class="string">"+8h"</span>)</span><br><span class="line"><span class="keyword">return</span> uTime.Add(dur)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 改</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetBjTime</span><span class="params">()</span> <span class="title">time</span>.<span class="title">Time</span></span> &#123;</span><br><span class="line"><span class="comment">// 将服务器UTC转成北京时间</span></span><br><span class="line">uTime := time.Now()</span><br><span class="line"><span class="keyword">return</span> uTime.In(time.FixedZone(<span class="string">"CST"</span>, <span class="number">8</span>*<span class="number">60</span>*<span class="number">60</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 同事用这个方法将得到的time.Time参与计算, 发现多了8个小时. 觉得有问题, 同事和我讨论了之后, 我们得出结论后就大意地直接把原有函数改了, 我们都没有意识到这是个非常危险操作, 只所以危险是因为这个函数已经在很多服务的代码里用着(要稳!不能乱动公共库!!!). 之前用这个函数是因为老Java项目运行在时区为东八区的系统上, 大量代码使用东八区时间, 但数据库MySQL时区设置为UTC, go项目也运行在UTC时区. 也就是说, Java项目在把时区为UTC数据库当做是东八区来用, Java程序往MySQL写东八区的时间字符串, 在sequel软件中看表内容时虽然字符串是一样的, 但其实内部是UTC的时间, go代码的mysql连接字符串中loc选项为空, 就会使用UTC时区去解析数据, 拿到的数据会多八个小时. 例如Java代码往mysql插入一条”2017-10-29 22:00:00”数据本意是东八区2017年10月29日22点, 但在MySQL内部看来, 这是UTC的2017年10月29日22点, 换算成东八区时间为2017年10月30日6点, 如果其它程序解析时认为时间数据是MySQL的UTC时区, 那么会得到一个错误的时间. 所以才会在GO中要往Java代码创建的表写入数据时用<code>time.Now().UTC().Add(time.Hour*8)</code>直接相加八小时使得Java项目行为一致, 拿UTC的数据库存东八区时间. </p>
<p> 后面想想, 面对这种数据库中有时区不一致数据的情况, 在没有办法统一UTC时区的情况下, 应当使用MySQL时间字符串而不是time.Time来传递以避免时区隐含转换问题, 写入时参数传string类型的时间字符串, 解析时先拿到时间字符串, 然后自行判断建表时这个字段用的是东八区的时间字符串还是UTC时间字符串进行time.ParseInLocation得到时间对象, MySQL连接字符串的parseTime选项要设置为false.  比如我想在MySQL中存东八区的当前时间, SQL参数用Format后的字符串而不是传time.Time, 原版的<code>time.Now().UTC().Add(time.Hour*8).Format(&quot;2006-01-02 15:04:05&quot;)</code>和修改的<code>time.Now().In(time.FixedZone(&quot;CST&quot;, 8*60*60))</code>的输出将是一样, 但后者是正确的东八区现在时间. 原版的GetBjTime()返回time.Time可能用GetBeijingNowTimeString返回string更能体现本意吧.</p>
</li>
</ol>
<h2 id="5-时间有关的标准"><a href="#5-时间有关的标准" class="headerlink" title="5. 时间有关的标准"></a>5. 时间有关的标准</h2><ul>
<li><p><a href="https://zh.wikipedia.org/wiki/UTC" target="_blank" rel="noopener">UTC</a> </p>
<blockquote>
<p>协调世界时（英语：Coordinated Universal Time，法语：Temps Universel Coordonné，简称UTC）是最主要的世界时间标准，其以原子时秒长为基础，在时刻上尽量接近于格林尼治标准时间。中华民国采用CNS 7648的《资料元及交换格式–资讯交换–日期及时间的表示法》（与ISO 8601类似）称之为世界协调时间。中华人民共和国采用ISO 8601:2000的国家标准GB/T 7408-2005《数据元和交换格式 信息交换 日期和时间表示法》中亦称之为协调世界时。<br>协调世界时是世界上调节时钟和时间的主要时间标准，它与0度经线的平太阳时相差不超过1秒[4]，并不遵守夏令时。协调世界时是最接近格林威治标准时间(GMT)的几个替代时间系统之一。对于大多数用途来说，UTC时间被认为能与GMT时间互换，但GMT时间已不再被科学界所确定。</p>
</blockquote>
</li>
<li><p><a href="https://zh.wikipedia.org/wiki/ISO_8601" target="_blank" rel="noopener">ISO 8601</a> 计算某一天在一年的第几周/循环时间RRlue/会用到此标准</p>
<blockquote>
<p>国际标准ISO 8601，是国际标准化组织的日期和时间的表示方法，全称为《数据存储和交换形式·信息交换·日期和时间的表示方法》。目前是第三版“ISO8601:2004”以替代第一版“ISO8601:1988”与第二版“ISO8601:2000”。</p>
</blockquote>
</li>
<li><a href="https://zh.wikipedia.org/wiki/UNIX%E6%97%B6%E9%97%B4" target="_blank" rel="noopener">UNIX时间</a><blockquote>
<p>UNIX时间，或称POSIX时间是UNIX或类UNIX系统使用的时间表示方式：从协调世界时1970年1月1日0时0分0秒起至现在的总秒数，不考虑闰秒[1]。 在多数Unix系统上Unix时间可以通过date +%s指令来检查。</p>
</blockquote>
</li>
<li><a href="https://zh.wikipedia.org/wiki/%E6%97%B6%E5%8C%BA%E5%88%97%E8%A1%A8" target="_blank" rel="noopener">时区</a><blockquote>
<p>时区列表</p>
</blockquote>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">hanjm</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/hanjm" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://colobu.com/" title="(一些有趣的博客列表)<br>鸟窝" target="_blank">(一些有趣的博客列表)<br>鸟窝</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.taozj.org/" title="taozj" target="_blank">taozj</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://feilengcui008.github.io/" title="feilengcui008" target="_blank">feilengcui008</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://lanlingzi.cn/" title="lanlingzi" target="_blank">lanlingzi</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://cizixs.com/" title="cizixs" target="_blank">cizixs</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://liaoph.com/" title="liaoph" target="_blank">liaoph</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://liyangliang.me/" title="liyangliang" target="_blank">liyangliang</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.ideawu.net/blog/" title="ideawu" target="_blank">ideawu</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://legendtkl.com/" title="legendtkl" target="_blank">legendtkl</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/v_JULY_v" title="算法之道" target="_blank">算法之道</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://surmon.me" title="surmon" target="_blank">surmon</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://shanshanpt.github.io/" title="shanshanpt" target="_blank">shanshanpt</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.zddhub.com/" title="zddhub" target="_blank">zddhub</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://luodw.cc/" title="luodw" target="_blank">luodw</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://xiaorui.cc/" title="xiaorui" target="_blank">xiaorui</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://zenlife.tk/index" title="TiDB" target="_blank">TiDB</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://xiequan.info/" title="谢权SELF" target="_blank">谢权SELF</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.songjiayang.com/" title="songjiayang" target="_blank">songjiayang</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://cjting.me/" title="cjting" target="_blank">cjting</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://kingname.info/" title="kingname" target="_blank">kingname</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://mritd.me/" title="漠然" target="_blank">漠然</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.xiayf.cn/gitbook/tech-note" title="xiayf" target="_blank">xiayf</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.40huo.cn/" title="40huo" target="_blank">40huo</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.nosuchfield.com/" title="nosuchfield" target="_blank">nosuchfield</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://holys.im/" title="holys" target="_blank">holys</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://icymind.com/" title="icymind" target="_blank">icymind</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://hackjutsu.com/" title="hackjutsu" target="_blank">hackjutsu</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://xcatliu.com/" title="流浪小猫" target="_blank">流浪小猫</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://xielong.me/" title="谢龙" target="_blank">谢龙</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://github.com/jiajunhuang/blog/blob/master/README.md" title="Jiajun" target="_blank">Jiajun</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://weny.name/about/" title="Weny" target="_blank">Weny</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.coldcofe.cn/" title="coldcofe" target="_blank">coldcofe</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.phpzjj.com/" title="张俊杰的博客" target="_blank">张俊杰的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://v2fw.com/" title="v2fw" target="_blank">v2fw</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wudaijun.com/" title="wudaijun" target="_blank">wudaijun</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://sanyuesha.com/" title="sanyuesha" target="_blank">sanyuesha</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hanjm</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>








        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://hanjmblog.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
